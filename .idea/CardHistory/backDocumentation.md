## *API Получение истории операций по картам*
## *История изменений*

|**Автор**|**Версия изменений**|**Описание**|**Задача**|
| :-: | :-: | :-: | :-: |

|Клубкова К.И.|1.1|Добавление истории операций|TASK-1|
**Цель:** сервис предназначен для получения списка операций по картам клиента.

**URL:** [endpoint]/api/operations/list

**Метод:** GET

**Доступ:** авторизованная зона. Сервис вызывается с фронта.

**Входные параметры:** нет 

|**Параметр**|**Тип поля**|**Описание**|**Обязательность**|
| :-: | :-: | :-: | :-: |
|forceRequest|Boolean|Признак принудительного запроса (получение актуальной инфы из АБС)|Да|
**Выходные параметры:**

|**Параметр**|**Тип поля**|**Описание**|**Обязательность**|
| :-: | :-: | :-: | :-: |
|data/operations|List[Object]|Список операций по карте|Нет|
|<p>data/operations/mccIcon</p><p> </p>|String|Иконка операции/мерчанта (урл до картинки)|Нет|
|<p>data/operations/mccName</p><p></p>|String|Наименование операции/мерчанта|Да|
|' 'data/operations/auth\_amount|Decimal|Сумма операции в валюте транзакции|Да|
|data/operations/ auth\_currency|String|Валюта операции||
|data/operations/card\_sign|String|Знак операции|Да|
Пример запроса/ответа:
## ***Основной сценарий (MC)***
Documentation/Attachments/Рисунок1.png
1. Сервис проверяет входные параметры запроса:
   1. Если получен параметр forceRequest == true, то переход к сценарию AC-1 - Получение краткой истории операций из АБС AllAboutCards.
   1. Иначе, сценарий продолжается.
1. Сервис выполняет поиск операций по текущей карте для текущего клиента в БД в таблице card\_operations.
1. Если в таблице card\_operations для текущего клиента отсутствуют операции по карте, то переход к сценарию AC-1 – Получение списка операций по картам из АБС AllAboutCards
1. Полученные операции обогащаются данными из базы сервиса по mcc коду
1. Сервис инициирует получение актуальных операций по каждой карте в рамках сценария SC-1
1. Сервис сортирует операции в порядке уменьшения значения даты, отображаются не более 5 операций за последние 10 дней.
1. Сервис формирует ответ согласно маппингу:

|**Параметр ответа**|**Правило формирования**|
| :-: | :-: |
|data/operations|-|
|data/operations/operationDesign|Значение card\_operations.mcc\_Icon|
|<p>data/operations/mccName</p><p></p>|Значение card\_operations.mcc\_name   в ответе AllAboutCards|
|data/operations/card\_sign|<p>Значение “-” если в card\_sign получено значение ‘debit’</p><p>Значение “ ” если в card\_sign получено значение ‘credit</p>|
|data/operations/oper\_type|<p>Значение “перевод по счету”, если получено значение ACC</p><p>Значение наличка, если получено значение KAS</p><p></p><p></p>|
|data/operations/auth\_amount|Значение cards\_operations.auth\_amount  в ответе AllAboutCards|
|data/operations/auth\_currency|Значение cards\_operations.auth\_currency в ответе AllAboutCards|
1. Сервис возвращает ответ вызывающей системе.
## ***Альтернативный сценарий (AC)***
АС-1. Получение краткого списка операций по картам из АБС AllAboutCards.

1. Сервис инициирует получение операций по картам клиента из AllAboutCards, формируя запрос:

|**Атрибут**|**Описание**|
| :-: | :-: |
|Cardid|Значение backSystemId, где backSystemCode==’AllAboutCards’, определенное для текущего клиента|
1. После получения ответа от бэк-системы, выполняется проверка, получена ли информация о списке операций:
   1. Если получен пустой ответ, ошибка или таймаут, то переход к сценарию ЕС-1
1. По событию получения ответа, сервис сохраняет список операций по картам в БД в таблицу card\_operations, согласно маппингу:

|**Поле в таблице** **cards\_operations**|**Поле в ответе AllAboutCards**|
| :- | :- |
|id|<p>-</p><p>Генерируемое автоматически значение</p>|
|card\_id/cardnumber|<p>-</p><p>Текущий ИД карты клиента</p>|
|iconURL|URL, по которому находится иконка,определяется по mcc коду в ответе AllAboutCards|
|mccName|Наименование мерчанта, определяется по mcc коду в ответе AllAboutCards|
|сard\_sign|<p>Значение “-” если в card\_sign получено значение «debit»</p><p>Значение “ ” если в card\_sign получено значение «credit»</p>|
|oper\_type|<p>Значение конфигурационных параметров:</p><p>IBN/POS/ATM/P2P/КОМ/KAS/ACC/ BAL</p>|
|auth\_amount|Сумма операции в валюте транзакции|
|auth\_currency|Валюта операции|
1. Сценарий продолжается с шага 4 Основного сценария – обогащение полученной истории операций по mcc коду.
## ***Cуб-сценарий (SC)***
SС-1. 1) Получение списка карт из АБС (АС-1, API «Получение списка карт»)  AllAboutCards.

\2) Получение полной истории операций из АБС deepCardOperations

1. Сервис инициирует получение списка карт
1. Сервис инициирует по каждой из этих карт клиента получение полного списка операций из deepCardOperations, формируя запрос:

|**Атрибут**|**Описание**|
| :-: | :-: |
|operationid|Значение backSystemId, где backSystemCode==’deepCardOperations’, определенное для текущего клиента|
|cardnum|Значение mainvirtnum в ответе AllAboutCards (значение выходного параметра взято |
1. После получения ответа от бэк-системы, выполняется проверка, получена ли полная история операций по картам:
   1. Если получен пустой ответ, ошибка или таймаут, то операции исключаются из списка
1. По событию получения ответа, сервис обновляет информацию об операциях по карте в БД в таблице card\_operations, согласно маппингу:

|**Поле в таблице card\_operations**|**Поле в ответе deepCardOperations**|
| :-: | :-: |
|Operation|Значение Operation в ответе deepCardOperations|
1. Сценарий продолжается с шага 4 Основного сценария - обогащение полученной истории операций по mcc коду.
1. Исключительные сценарии (EC)

ЕС-1. У клиента нет по карте ни одной операции

1. Сервис формирует ответ, согласно маппингу.

|**Параметр ответа**|**Правило формирования**|
| :- | :- |
|data/error/code|Код ошибки|
|data/error/text|“У вас нет ни одной операции по данной карте”|
1. API возвращает ответ.

**Конфигурационные параметры**

|**Название конфига**|**Значение**|**Описание**|
| :- | :- | :- |
|IBN|оплата услуг в ИБ||
|' 'POS|' 'POS||
|ATM|наличка||
|BAL|платный запрос баланса карты||
|P2P|P2P||
|КОМ|комиссия||
|KAS|наличка||
|ACC |перевод по счету||

**


==


